---
# GitOps : installer ArgoCD + créer les Application CRs
# Structure : Jenkinsfile, argocd/, playbooks/, roles/ au même niveau.
#   - Chart à côté de playbooks/ : {{ playbook_dir }}/../argocd/
#   - Chart au niveau parent (infra/argocd) : {{ playbook_dir }}/../../argocd/

- name: GitOps (ArgoCD)
  hosts: localhost
  gather_facts: true
  vars:
    # Répertoire qui contient playbooks/ (même niveau que Jenkinsfile et argocd/)
    ansible_root: "{{ playbook_dir }}/.."
  tasks:
    - name: Chart ArgoCD à côté de playbooks/ (argocd/Chart.yaml)
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/../argocd/Chart.yaml"
      register: argocd_in_repo

    - name: Chart ArgoCD au niveau parent (infra/argocd)
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/../../argocd/Chart.yaml"
      register: argocd_sibling

    - name: Définir les chemins du chart ArgoCD
      ansible.builtin.set_fact:
        argocd_chart_path: "{{ (playbook_dir + '/../argocd') if argocd_in_repo.stat.exists else (playbook_dir + '/../../argocd') }}"
        argocd_values_file: "{{ (playbook_dir + '/../argocd/values.yaml') if argocd_in_repo.stat.exists else (playbook_dir + '/../../argocd/values.yaml') }}"
      when: argocd_in_repo.stat.exists or argocd_sibling.stat.exists

    - name: Échec si le chart ArgoCD est introuvable (uniquement si on lance l'install)
      ansible.builtin.fail:
        msg: "Chart ArgoCD introuvable. Ajouter argocd/ (Chart.yaml, values.yaml) à la racine du repo, ou lancer avec --tags applications pour ne créer que les Application CRs."
      when: >-
        not (argocd_in_repo.stat.exists or argocd_sibling.stat.exists)
        and ('install' in (ansible_run_tags | default([])) or 'argocd' in (ansible_run_tags | default([])) or (ansible_run_tags | default([]) | length == 0))

    - name: Installer / mettre à jour ArgoCD (Helm)
      ansible.builtin.include_role:
        name: argocd_install
      tags: [install, argocd]

    - name: Créer ou mettre à jour les applications ArgoCD
      ansible.builtin.include_role:
        name: argocd_applications
      tags: [applications, apps]
