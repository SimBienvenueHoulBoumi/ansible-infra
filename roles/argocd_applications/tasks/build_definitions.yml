---
# Construire les définitions Application à partir de argocd_applications

- name: Construire chaque définition Application ArgoCD
  ansible.builtin.set_fact:
    argocd_application_definitions: "{{ argocd_application_definitions | default([]) + [app_spec] }}"
  loop: "{{ argocd_applications }}"
  loop_control:
    loop_var: app
  vars:
    _helm_base:
      releaseName: "{{ app.name }}"
      valueFiles: "{{ app.helm_value_files | default([]) }}"
    _helm_values_yaml: "{{ (app.helm_values | default({})) | to_nice_yaml }}"
    _helm_spec: "{{ _helm_base | combine({'values': _helm_values_yaml}) }}"
    app_spec:
      apiVersion: argoproj.io/v1alpha1
      kind: Application
      metadata:
        name: "{{ app.name }}"
        namespace: "{{ argocd_namespace }}"
        finalizers:
          - resources-finalizer.argocd.argoproj.io
      spec:
        project: "{{ app.project | default('default') }}"
        source:
          repoURL: "{{ app.repo_url }}"
          targetRevision: "{{ app.target_revision | default('HEAD') }}"
          path: "{{ app.path }}"
          helm: "{{ _helm_spec }}"
        destination:
          server: "{{ argocd_destination_server }}"
          namespace: "{{ app.namespace }}"
        syncPolicy: "{{ app.sync_policy | default({}) }}"
